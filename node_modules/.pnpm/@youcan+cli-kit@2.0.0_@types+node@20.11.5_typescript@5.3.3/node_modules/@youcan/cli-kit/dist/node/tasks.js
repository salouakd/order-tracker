import { exit } from 'node:process';
import { Loader } from '../internal/node/ui.js';

async function runTask(task, ctx) {
    if (task.skip?.(ctx)) {
        return;
    }
    return await task.task(ctx, task);
}
async function run(ctx, tasks) {
    for await (const task of tasks) {
        await Loader.exec(task.title, async (loader) => {
            try {
                const subtasks = await runTask(task, ctx);
                if (Array.isArray(subtasks) && subtasks.length > 0 && subtasks.every(t => 'task' in t)) {
                    for await (const subtask of subtasks) {
                        await runTask(subtask, ctx);
                    }
                }
                loader.stop();
            }
            catch (err) {
                loader.error(String(err));
                exit(1);
            }
        });
    }
    return ctx;
}

export { run };
