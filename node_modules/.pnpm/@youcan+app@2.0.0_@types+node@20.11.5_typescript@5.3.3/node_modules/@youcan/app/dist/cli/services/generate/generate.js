import { Path, Filesystem, Git } from '@youcan/cli-kit';
import { EXTENSION_CONFIG_FILENAME } from '../../../constants.js';

async function ensureExtensionDirectoryExists(name) {
    const dir = Path.join(Path.cwd(), 'extensions', name);
    if (await Filesystem.exists(dir)) {
        throw new Error(`The '${name}' already exists, choose a new name for your extension`);
    }
    await Filesystem.mkdir(dir);
    return dir;
}
async function initThemeExtension(options) {
    return Filesystem.tapIntoTmp(async (tmp) => {
        const directory = Path.join(tmp, 'download');
        await Filesystem.mkdir(directory);
        await Git.clone({
            url: options.type.url,
            destination: directory,
            shallow: true,
        });
        const flavorPath = Path.join(directory, options.flavor?.path || '');
        if (!await Filesystem.exists(flavorPath)) {
            throw new Error(`Extension flavor '${options.flavor?.name}' is unavailble`);
        }
        await Filesystem.move(flavorPath, options.directory, { overwrite: true });
        await Filesystem.writeJsonFile(Path.join(options.directory, EXTENSION_CONFIG_FILENAME), { name: options.name, type: options.type.type });
    });
}

export { ensureExtensionDirectoryExists, initThemeExtension };
